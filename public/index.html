<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>swag.dev Auth - Admin Panel</title>
    <style>
        :root {
            --primary-color: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --secondary-color: #1f2937;
            --text-color: #f9fafb;
            --text-muted: #9ca3af;
            --background-color: #0f172a;
            --card-background: #1e293b;
            --success-color: #10b981;
            --error-color: #ef4444;
            --warning-color: #f59e0b;
            --border-color: #374151;
            --hover-bg: #334155;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--background-color) 0%, #1e293b 100%);
            color: var(--text-color);
            overflow-x: hidden;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .page {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }

            .page.active {
                display: block;
            }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: radial-gradient(circle at 50% 50%, rgba(99, 102, 241, 0.1) 0%, transparent 50%);
        }

        .login-card {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(99, 102, 241, 0.2);
            transition: all 0.3s ease;
        }

            .login-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 35px 60px -12px rgba(0, 0, 0, 0.4);
            }

        .logo-container {
            text-align: center;
            margin-bottom: 30px;
        }

        .brand-title {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .brand-subtitle {
            color: var(--text-muted);
            font-size: 1.1rem;
            font-weight: 500;
        }

        h1, h2, h3 {
            color: var(--text-color);
            margin-bottom: 20px;
        }

        .input-group {
            margin-bottom: 24px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-color);
            font-weight: 500;
            font-size: 0.9rem;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 16px;
            border-radius: 12px;
            border: 2px solid var(--border-color);
            background-color: var(--secondary-color);
            color: var(--text-color);
            outline: none;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

            input:focus, select:focus, textarea:focus {
                border-color: var(--primary-color);
                box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
                transform: translateY(-2px);
            }

        button {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: var(--text-color);
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
            font-size: 1rem;
            position: relative;
            overflow: hidden;
        }

            button::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
                transition: left 0.5s;
            }

            button:hover::before {
                left: 100%;
            }

            button:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 25px rgba(99, 102, 241, 0.3);
            }

            button:active {
                transform: translateY(0);
            }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px 0;
            border-bottom: 2px solid var(--border-color);
        }

        .dashboard-title {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-tabs {
            display: flex;
            margin-bottom: 30px;
            background: var(--card-background);
            border-radius: 16px;
            padding: 6px;
            border: 1px solid var(--border-color);
        }

        .nav-tab {
            flex: 1;
            padding: 12px 20px;
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
            font-weight: 500;
            position: relative;
        }

            .nav-tab:hover {
                background: var(--hover-bg);
                color: var(--primary-light);
            }

            .nav-tab.active {
                background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
                color: var(--text-color);
                box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
            }

        .tab-content {
            display: none;
        }

            .tab-content.active {
                display: block;
                animation: slideIn 0.4s ease-out;
            }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .card {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

            .card:hover {
                border-color: var(--primary-color);
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            }

        .search-container {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

            .search-container input {
                flex: 1;
            }

        .key-item, .user-item, .app-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            margin-bottom: 12px;
            background: var(--secondary-color);
            border-radius: 12px;
            border-left: 4px solid var(--primary-color);
            transition: all 0.3s ease;
        }

            .key-item:hover, .user-item:hover, .app-item:hover {
                background: var(--hover-bg);
                transform: translateX(4px);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            }

        .key-info, .user-info, .app-info {
            flex: 1;
        }

            .key-info div, .user-info div, .app-info div {
                margin-bottom: 6px;
                font-size: 0.9rem;
            }

        .key-actions, .user-actions, .app-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 8px 16px;
            font-size: 0.85rem;
            border-radius: 8px;
            background: var(--card-background);
            border: 1px solid var(--border-color);
        }

            .action-btn:hover {
                background: var(--primary-color);
                border-color: var(--primary-color);
                transform: translateY(-1px);
            }

        .active-status {
            color: var(--success-color);
            font-weight: 600;
        }

        .paused {
            color: var(--warning-color);
            font-weight: 600;
        }

        .banned {
            color: var(--error-color);
            font-weight: 600;
        }

        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(20px);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            border: 1px solid var(--border-color);
            display: none;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            max-width: 500px;
            width: 90%;
        }

            .popup.show {
                transform: translate(-50%, -50%) scale(1);
            }

            .popup h3 {
                margin-bottom: 20px;
                color: var(--primary-color);
            }

            .popup button {
                margin-top: 20px;
                margin-right: 12px;
            }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            min-width: 300px;
        }

            .notification.success {
                background: linear-gradient(135deg, var(--success-color), #059669);
            }

            .notification.error {
                background: linear-gradient(135deg, var(--error-color), #dc2626);
            }

            .notification.show {
                opacity: 1;
                transform: translateX(0);
            }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--primary-color);
            font-size: 1.1rem;
        }

            .loading::after {
                content: '';
                display: inline-block;
                width: 20px;
                height: 20px;
                margin-left: 10px;
                border: 2px solid var(--primary-color);
                border-top: 2px solid transparent;
                border-radius: 50%;
                animation: spin 1s linear infinite;
            }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .error-message {
            color: var(--error-color);
            text-align: center;
            padding: 40px;
            font-size: 1.1rem;
        }

        .empty-message {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
            font-size: 1.1rem;
        }

        .scrollable {
            max-height: 500px;
            overflow-y: auto;
            margin-bottom: 15px;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) var(--card-background);
        }

            .scrollable::-webkit-scrollbar {
                width: 6px;
            }

            .scrollable::-webkit-scrollbar-track {
                background: var(--card-background);
                border-radius: 3px;
            }

            .scrollable::-webkit-scrollbar-thumb {
                background: var(--primary-color);
                border-radius: 3px;
            }

        .logout-btn {
            background: linear-gradient(135deg, var(--error-color), #dc2626);
        }

            .logout-btn:hover {
                background: linear-gradient(135deg, #dc2626, #b91c1c);
            }

        #customDaysContainer {
            display: none;
            margin-top: 10px;
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        @media (max-width: 768px) {
            .key-item, .user-item, .app-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }

            .key-actions, .user-actions, .app-actions {
                width: 100%;
                justify-content: flex-start;
            }

            .nav-tabs {
                overflow-x: auto;
                white-space: nowrap;
            }

            .dashboard-header {
                flex-direction: column;
                gap: 16px;
                text-align: center;
            }

            .brand-title {
                font-size: 2rem;
            }
        }

        /* Enhanced button styles */
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #059669);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #d97706);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--error-color), #dc2626);
        }

        /* Card animations */
        .card-animate {
            animation: cardSlideUp 0.6s ease-out;
        }

        @keyframes cardSlideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div id="adminDashboard" class="page active">
        <div class="container">
            <div class="dashboard-header">
                <div class="dashboard-title">swag.dev Auth Panel</div>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>

            <div class="nav-tabs">
                <div class="nav-tab active" onclick="switchTab('keysTab')">Keys</div>
                <div class="nav-tab" onclick="switchTab('usersTab')">Users</div>
                <div class="nav-tab" onclick="switchTab('applicationsTab')">Applications</div>
            </div>

            <div id="keysTab" class="tab-content active">
                <div class="card card-animate">
                    <h2>Create New Key</h2>
                    <div class="input-group">
                        <label for="keyType">Key Type</label>
                        <select id="keyType" onchange="toggleCustomDays()">
                            <option value="day">1 Day</option>
                            <option value="3day">3 Days</option>
                            <option value="week">1 Week</option>
                            <option value="month">1 Month</option>
                            <option value="lifetime">Lifetime</option>
                            <option value="custom">Custom Days</option>
                        </select>
                    </div>
                    <div id="customDaysContainer" class="input-group">
                        <label for="customDays">Number of Days</label>
                        <input type="number" id="customDays" min="1" value="1">
                    </div>
                    <div class="input-group">
                        <label for="keyUsername">Username (Optional)</label>
                        <input type="text" id="keyUsername" placeholder="Enter username">
                    </div>
                    <div class="input-group">
                        <label for="keyApplication">Application</label>
                        <select id="keyApplication">
                            <option value="default">Default</option>
                        </select>
                    </div>
                    <button onclick="createKey()" class="btn-primary">Create Key</button>
                </div>

                <div class="card card-animate">
                    <h2>Manage Keys</h2>
                    <div class="search-container">
                        <input type="text" id="keySearch" placeholder="Search keys..." onkeyup="filterKeys()">
                        <button onclick="refreshKeys()" class="btn-primary">Refresh</button>
                    </div>
                    <div class="key-actions" style="margin-bottom: 15px; gap: 12px;">
                        <button onclick="pauseAllKeys()" class="btn-warning">Pause All</button>
                        <button onclick="resumeAllKeys()" class="btn-success">Resume All</button>
                    </div>
                    <div id="keysList" class="scrollable">
                        <div class="loading pulse">Loading keys</div>
                    </div>
                </div>
            </div>

            <div id="usersTab" class="tab-content">
                <div class="card card-animate">
                    <h2>Manage Users</h2>
                    <div class="search-container">
                        <input type="text" id="userSearch" placeholder="Search users..." onkeyup="filterUsers()">
                        <button onclick="refreshUsers()" class="btn-primary">Refresh</button>
                    </div>
                    <div id="usersList" class="scrollable">
                        <div class="loading pulse">Loading users</div>
                    </div>
                </div>
            </div>

            <div id="applicationsTab" class="tab-content">
                <div class="card card-animate">
                    <h2>Add New Application</h2>
                    <div class="input-group">
                        <label for="appName">Application Name</label>
                        <input type="text" id="appName" placeholder="Enter application name">
                    </div>
                    <button onclick="addApplication()" class="btn-primary">Add Application</button>
                </div>

                <div class="card card-animate">
                    <h2>Manage Applications</h2>
                    <div class="search-container">
                        <input type="text" id="appSearch" placeholder="Search applications..." onkeyup="filterApplications()">
                        <button onclick="refreshApplications()" class="btn-primary">Refresh</button>
                    </div>
                    <div id="applicationsList" class="scrollable">
                        <div class="loading pulse">Loading applications</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Popups -->
    <div id="keyInfoPopup" class="popup">
        <h3>Key Information</h3>
        <div id="keyInfoContent"></div>
        <button onclick="closePopup('keyInfoPopup')" class="btn-primary">Close</button>
    </div>

    <div id="extendKeyPopup" class="popup">
        <h3>Extend Key</h3>
        <div class="input-group">
            <label for="extendKeyType">Extension Type</label>
            <select id="extendKeyType" onchange="toggleExtendCustomDays()">
                <option value="day">1 Day</option>
                <option value="3day">3 Days</option>
                <option value="week">1 Week</option>
                <option value="month">1 Month</option>
                <option value="lifetime">Lifetime</option>
                <option value="custom">Custom Days</option>
            </select>
        </div>
        <div id="extendCustomDaysContainer" class="input-group" style="display: none;">
            <label for="extendCustomDays">Number of Days</label>
            <input type="number" id="extendCustomDays" min="1" value="1">
        </div>
        <input type="hidden" id="extendKeyId">
        <button onclick="extendKeyConfirm()" class="btn-success">Extend</button>
        <button onclick="closePopup('extendKeyPopup')">Cancel</button>
    </div>

    <div id="userKeysPopup" class="popup">
        <h3>User Keys</h3>
        <div id="userKeysContent" class="scrollable"></div>
        <button onclick="closePopup('userKeysPopup')" class="btn-primary">Close</button>
    </div>

    <div id="confirmationPopup" class="popup">
        <h3 id="confirmationTitle">Confirmation</h3>
        <p id="confirmationMessage">Are you sure you want to proceed?</p>
        <button id="confirmButton" onclick="confirmAction()" class="btn-danger">Confirm</button>
        <button onclick="closePopup('confirmationPopup')">Cancel</button>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        // Global variables
        let currentUser = null;
        let allKeys = [];
        let allUsers = [];
        let allApplications = [];
        let confirmationCallback = null;

        // Helper functions
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
        }

        function switchTab(tabId) {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            document.querySelector(`.nav-tab[onclick="switchTab('${tabId}')"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }

        function showPopup(popupId) {
            document.getElementById(popupId).style.display = 'block';
        }

        function closePopup(popupId) {
            document.getElementById(popupId).style.display = 'none';
        }

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification ' + type;
            notification.classList.add('show');

            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'Never';
            return new Date(timestamp).toLocaleString();
        }

        function toggleCustomDays() {
            const keyType = document.getElementById('keyType').value;
            const customDaysContainer = document.getElementById('customDaysContainer');

            if (keyType === 'custom') {
                customDaysContainer.style.display = 'block';
            } else {
                customDaysContainer.style.display = 'none';
            }
        }

        function toggleExtendCustomDays() {
            const keyType = document.getElementById('extendKeyType').value;
            const customDaysContainer = document.getElementById('extendCustomDaysContainer');

            if (keyType === 'custom') {
                customDaysContainer.style.display = 'block';
            } else {
                customDaysContainer.style.display = 'none';
            }
        }

        // API functions
        async function apiRequest(endpoint, method = 'GET', data = null) {
            try {
                const url = `/api${endpoint}`;
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json'
                    }
                };

                // Get current user from localStorage
                const storedUser = localStorage.getItem('currentUser');
                const currentUser = storedUser ? JSON.parse(storedUser) : null;

                // For GET requests, we need to add authentication as query parameters
                if (method === 'GET' && currentUser && currentUser.username && currentUser.password) {
                    // For GET requests, we can't use a body, so we'll modify the authenticateAdmin middleware
                    // to accept query parameters instead for these specific endpoints
                    // This is a workaround - a better solution would be to use headers or cookies

                    // For now, we'll just make the request without authentication for GET
                    // and handle it on the server side
                }
                // For non-GET requests, include credentials in the body
                else if (method !== 'GET') {
                    if (endpoint !== '/admin/login' && currentUser && currentUser.username && currentUser.password) {
                        // Include authentication in the body
                        const authData = {
                            username: currentUser.username,
                            password: currentUser.password
                        };

                        // Merge with existing data if any
                        if (data) {
                            options.body = JSON.stringify({
                                ...data,
                                ...authData
                            });
                        } else {
                            options.body = JSON.stringify(authData);
                        }
                    }
                    // For login or if we have data but no user
                    else if (data) {
                        options.body = JSON.stringify(data);
                    }
                }

                console.log(`Making ${method} request to ${url}`);

                const response = await fetch(url, options);

                // Handle non-JSON responses
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    const result = await response.json();

                    if (!response.ok) {
                        throw new Error(result.message || `Request failed with status ${response.status}`);
                    }

                    return result;
                } else {
                    if (!response.ok) {
                        throw new Error(`Request failed with status ${response.status}`);
                    }

                    return { success: true };
                }
            } catch (error) {
                console.error('API request error:', error);
                showNotification(error.message || 'An error occurred', 'error');
                throw error;
            }
        }

        // Authentication functions
        function logout() {
            currentUser = null;
            showPage('adminDashboard');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        // Keys functions
        async function refreshKeys() {
            try {
                document.getElementById('keysList').innerHTML = '<div class="loading">Loading keys...</div>';

                const result = await apiRequest('/keys');
                allKeys = result.keys;

                renderKeys(allKeys);
                loadApplicationsDropdown();
            } catch (error) {
                document.getElementById('keysList').innerHTML = '<div class="error-message">Failed to load keys</div>';
            }
        }

        function renderKeys(keys) {
            const keysListElement = document.getElementById('keysList');

            if (keys.length === 0) {
                keysListElement.innerHTML = '<div class="empty-message">No keys found</div>';
                return;
            }

            // Sort keys by creation date (newest first)
            keys.sort((a, b) => b.createdAt - a.createdAt);

            let html = '';

            keys.forEach(key => {
                const isExpired = key.expiresAt < Date.now();
                const statusClass = key.isBanned ? 'banned' : !key.isActive ? 'paused' : isExpired ? 'banned' : 'active-status';
                const statusText = key.isBanned ? 'Banned' : !key.isActive ? 'Paused' : isExpired ? 'Expired' : 'Active';

                html += `
                                    <div class="key-item">
                                        <div class="key-info">
                                            <div><strong>Key:</strong> ${key.key}</div>
                                            <div><strong>Type:</strong> ${key.type}</div>
                                            <div><strong>Status:</strong> <span class="${statusClass}">${statusText}</span></div>
                                            <div><strong>Username:</strong> ${key.username || 'None'}</div>
                                            <div><strong>Application:</strong> ${key.application || 'Default'}</div>
                                        </div>
                                        <div class="key-actions">
                                            <button class="action-btn" onclick="viewKeyInfo('${key.key}')">Info</button>
                                            <button class="action-btn" onclick="extendKey('${key.key}')">Extend</button>
                                            ${key.isActive ?
                        `<button class="action-btn" onclick="pauseKey('${key.key}')">Pause</button>` :
                        `<button class="action-btn" onclick="resumeKey('${key.key}')">Resume</button>`
                    }
                                            ${key.isBanned ?
                        `<button class="action-btn" onclick="unbanKey('${key.key}')">Unban</button>` :
                        `<button class="action-btn" onclick="banKey('${key.key}')">Ban</button>`
                    }
                                            <button class="action-btn" onclick="resetHWID('${key.key}')">Reset HWID</button>
                                            <button class="action-btn" onclick="confirmDelete('${key.key}')">Delete</button>
                                        </div>
                                    </div>
                                `;
            });

            keysListElement.innerHTML = html;
        }

        function filterKeys() {
            const searchTerm = document.getElementById('keySearch').value.toLowerCase();

            if (!searchTerm) {
                renderKeys(allKeys);
                return;
            }

            const filteredKeys = allKeys.filter(key =>
                key.key.toLowerCase().includes(searchTerm) ||
                (key.username && key.username.toLowerCase().includes(searchTerm)) ||
                (key.application && key.application.toLowerCase().includes(searchTerm))
            );

            renderKeys(filteredKeys);
        }

        async function createKey() {
            const keyType = document.getElementById('keyType').value;
            const username = document.getElementById('keyUsername').value.trim();
            const application = document.getElementById('keyApplication').value;
            let customDays = null;

            if (keyType === 'custom') {
                customDays = parseInt(document.getElementById('customDays').value);
                if (isNaN(customDays) || customDays < 1) {
                    showNotification('Please enter a valid number of days', 'error');
                    return;
                }
            }

            try {
                const data = {
                    type: keyType,
                    username: username || null,
                    application
                };

                if (keyType === 'custom') {
                    data.customDays = customDays;
                }

                const result = await apiRequest('/keys/create', 'POST', data);

                if (result.success) {
                    showNotification('Key created successfully', 'success');
                    refreshKeys();

                    // Clear input fields
                    document.getElementById('keyUsername').value = '';
                    document.getElementById('keyType').value = 'day';
                    document.getElementById('customDays').value = '1';
                    document.getElementById('customDaysContainer').style.display = 'none';
                }
            } catch (error) {
                // Error is already handled in apiRequest
            }
        }

        async function viewKeyInfo(key) {
            try {
                const result = await apiRequest(`/keys/${key}`);

                if (result.success) {
                    const keyData = result.key;
                    const isExpired = keyData.expiresAt < Date.now();
                    const statusClass = keyData.isBanned ? 'banned' : !keyData.isActive ? 'paused' : isExpired ? 'banned' : 'active-status';
                    const statusText = keyData.isBanned ? 'Banned' : !keyData.isActive ? 'Paused' : isExpired ? 'Expired' : 'Active';

                    let html = `
                                    <div><strong>Key:</strong> ${keyData.key}</div>
                                    <div><strong>Type:</strong> ${keyData.type}</div>
                                    <div><strong>Status:</strong> <span class="${statusClass}">${statusText}</span></div>
                                    <div><strong>Created:</strong> ${formatDate(keyData.createdAt)}</div>
                                    <div><strong>Expires:</strong> ${formatDate(keyData.expiresAt)}</div>
                                    <div><strong>Username:</strong> ${keyData.username || 'None'}</div>
                                    <div><strong>HWID:</strong> ${keyData.hwid || 'Not set'}</div>
                                    <div><strong>Last Used:</strong> ${formatDate(keyData.lastUsed)}</div>
                                    <div><strong>Application:</strong> ${keyData.application || 'Default'}</div>
                                `;

                    document.getElementById('keyInfoContent').innerHTML = html;
                    showPopup('keyInfoPopup');
                }
            } catch (error) {
                // Error is already handled in apiRequest
            }
        }

        function extendKey(key) {
            document.getElementById('extendKeyId').value = key;
            document.getElementById('extendKeyType').value = 'day';
            document.getElementById('extendCustomDays').value = '1';
            document.getElementById('extendCustomDaysContainer').style.display = 'none';
            showPopup('extendKeyPopup');
        }

        async function extendKeyConfirm() {
            const key = document.getElementById('extendKeyId').value;
            const type = document.getElementById('extendKeyType').value;
            let customDays = null;

            if (type === 'custom') {
                customDays = parseInt(document.getElementById('extendCustomDays').value);
                if (isNaN(customDays) || customDays < 1) {
                    showNotification('Please enter a valid number of days', 'error');
                    return;
                }
            }

            try {
                const data = { type };

                if (type === 'custom') {
                    data.customDays = customDays;
                }

                const result = await apiRequest(`/keys/${key}/extend`, 'PUT', data);

                if (result.success) {
                    showNotification('Key extended successfully', 'success');
                    closePopup('extendKeyPopup');
                    refreshKeys();
                }
            } catch (error) {
                // Error is already handled in apiRequest
            }
        }

        async function pauseKey(key) {
            try {
                const result = await apiRequest(`/keys/${key}/pause`, 'PUT');

                if (result.success) {
                    showNotification('Key paused successfully', 'success');
                    refreshKeys();
                }
            } catch (error) {
                // Error is already handled in apiRequest
            }
        }

        async function resumeKey(key) {
            try {
                const result = await apiRequest(`/keys/${key}/resume`, 'PUT');

                if (result.success) {
                    showNotification('Key resumed successfully', 'success');
                    refreshKeys();
                }
            } catch (error) {
                // Error is already handled in apiRequest
            }
        }

        async function banKey(key) {
            try {
                const result = await apiRequest(`/keys/${key}/ban`, 'PUT');

                if (result.success) {
                    showNotification('Key banned successfully', 'success');
                    refreshKeys();
                }
            } catch (error) {
                // Error is already handled in apiRequest
            }
        }

        async function unbanKey(key) {
            try {
                const result = await apiRequest(`/keys/${key}/unban`, 'PUT');

                if (result.success) {
                    showNotification('Key unbanned successfully', 'success');
                    refreshKeys();
                }
            } catch (error) {
                // Error is already handled in apiRequest
            }
        }

        async function resetHWID(key) {
            try {
                const result = await apiRequest(`/keys/${key}/reset-hwid`, 'PUT');

                if (result.success) {
                    showNotification('HWID reset successfully', 'success');
                    refreshKeys();
                }
            } catch (error) {
                // Error is already handled in apiRequest
            }
        }

        function confirmDelete(key) {
            document.getElementById('confirmationTitle').textContent = 'Delete Key';
            document.getElementById('confirmationMessage').textContent = `Are you sure you want to delete the key: ${key}?`;

            confirmationCallback = async () => {
                try {
                    const result = await apiRequest(`/keys/${key}`, 'DELETE');

                    if (result.success) {
                        showNotification('Key deleted successfully', 'success');
                        refreshKeys();
                    }
                } catch (error) {
                    // Error is already handled in apiRequest
                }
            };

            showPopup('confirmationPopup');
        }

        async function pauseAllKeys() {
            try {
                const result = await apiRequest('/keys/pause-all', 'PUT');

                if (result.success) {
                    showNotification('All keys paused successfully', 'success');
                    refreshKeys();
                }
            } catch (error) {
                // Error is already handled in apiRequest
            }
        }

        async function resumeAllKeys() {
            try {
                const result = await apiRequest('/keys/resume-all', 'PUT');

                if (result.success) {
                    showNotification('All keys resumed successfully', 'success');
                    refreshKeys();
                }
            } catch (error) {
                // Error is already handled in apiRequest
            }
        }

        // Users functions
        async function refreshUsers() {
            try {
                document.getElementById('usersList').innerHTML = '<div class="loading">Loading users...</div>';

                const result = await apiRequest('/users');
                allUsers = result.users;

                renderUsers(allUsers);
            } catch (error) {
                document.getElementById('usersList').innerHTML = '<div class="error-message">Failed to load users</div>';
            }
        }

        function renderUsers(users) {
            const usersListElement = document.getElementById('usersList');

            if (users.length === 0) {
                usersListElement.innerHTML = '<div class="empty-message">No users found</div>';
                return;
            }

            // Sort users by username
            users.sort((a, b) => a.username.localeCompare(b.username));

            let html = '';

            users.forEach(user => {
                html += `
                                <div class="user-item">
                                    <div class="user-info">
                                        <div><strong>Username:</strong> ${user.username}</div>
                                        <div><strong>Keys:</strong> ${user.keyCount}</div>
                                        <div><strong>HWID:</strong> ${user.hwid || 'Not set'}</div>
                                        <div><strong>Last Login:</strong> ${formatDate(user.lastLogin)}</div>
                                    </div>
                                    <div class="user-actions">
                                        <button class="action-btn" onclick="viewUserKeys('${user.username}')">View Keys</button>
                                        <button class="action-btn" onclick="resetUserHWID('${user.username}')">Reset HWID</button>
                                    </div>
                                </div>
                            `;
            });

            usersListElement.innerHTML = html;
        }

        function filterUsers() {
            const searchTerm = document.getElementById('userSearch').value.toLowerCase();

            if (!searchTerm) {
                renderUsers(allUsers);
                return;
            }

            const filteredUsers = allUsers.filter(user =>
                user.username.toLowerCase().includes(searchTerm)
            );

            renderUsers(filteredUsers);
        }

        async function viewUserKeys(username) {
            try {
                const result = await apiRequest(`/users/${username}/keys`);

                if (result.success) {
                    const keys = result.keys;

                    if (keys.length === 0) {
                        document.getElementById('userKeysContent').innerHTML = '<div class="empty-message">No keys found for this user</div>';
                    } else {
                        let html = '';

                        keys.forEach(key => {
                            const isExpired = key.expiresAt < Date.now();
                            const statusClass = key.isBanned ? 'banned' : !key.isActive ? 'paused' : isExpired ? 'banned' : 'active-status';
                            const statusText = key.isBanned ? 'Banned' : !key.isActive ? 'Paused' : isExpired ? 'Expired' : 'Active';

                            html += `
                                            <div class="key-item">
                                                <div class="key-info">
                                                    <div><strong>Key:</strong> ${key.key}</div>
                                                    <div><strong>Type:</strong> ${key.type}</div>
                                                    <div><strong>Status:</strong> <span class="${statusClass}">${statusText}</span></div>
                                                    <div><strong>Expires:</strong> ${formatDate(key.expiresAt)}</div>
                                                    <div><strong>Application:</strong> ${key.application || 'Default'}</div>
                                                </div>
                                            </div>
                                        `;
                        });

                        document.getElementById('userKeysContent').innerHTML = html;
                    }

                    showPopup('userKeysPopup');
                }
            } catch (error) {
                // Error is already handled in apiRequest
            }
        }

        async function resetUserHWID(username) {
            try {
                const result = await apiRequest(`/users/${username}/reset-hwid`, 'PUT');

                if (result.success) {
                    showNotification('User HWID reset successfully', 'success');
                    refreshUsers();
                }
            } catch (error) {
                // Error is already handled in apiRequest
            }
        }

        // Applications functions
        async function refreshApplications() {
            try {
                document.getElementById('applicationsList').innerHTML = '<div class="loading">Loading applications...</div>';

                const result = await apiRequest('/applications');
                allApplications = result.applications;

                renderApplications(allApplications);
                loadApplicationsDropdown();
            } catch (error) {
                document.getElementById('applicationsList').innerHTML = '<div class="error-message">Failed to load applications</div>';
            }
        }

        function renderApplications(applications) {
            const applicationsListElement = document.getElementById('applicationsList');

            if (applications.length === 0) {
                applicationsListElement.innerHTML = '<div class="empty-message">No applications found</div>';
                return;
            }

            // Sort applications by name
            applications.sort((a, b) => a.name.localeCompare(b.name));

            let html = '';

            applications.forEach(app => {
                const isDefault = app.name === 'default';

                html += `
                                <div class="app-item">
                                    <div class="app-info">
                                        <div><strong>Name:</strong> ${app.name}</div>
                                        <div><strong>Status:</strong> <span class="${app.isActive ? 'active-status' : 'paused'}">${app.isActive ? 'Active' : 'Paused'}</span></div>
                                        <div><strong>Key Count:</strong> ${app.keyCount}</div>
                                        <div><strong>Created:</strong> ${formatDate(app.createdAt)}</div>
                                    </div>
                                    <div class="app-actions">
                                        ${app.isActive ?
                        `<button class="action-btn" onclick="toggleApplication('${app.name}')">Pause</button>` :
                        `<button class="action-btn" onclick="toggleApplication('${app.name}')">Resume</button>`
                    }
                                        ${!isDefault ?
                        `<button class="action-btn" onclick="confirmDeleteApplication('${app.name}')">Delete</button>` :
                        ''
                    }
                                    </div>
                                </div>
                            `;
            });

            applicationsListElement.innerHTML = html;
        }

        function filterApplications() {
            const searchTerm = document.getElementById('appSearch').value.toLowerCase();

            if (!searchTerm) {
                renderApplications(allApplications);
                return;
            }

            const filteredApps = allApplications.filter(app =>
                app.name.toLowerCase().includes(searchTerm)
            );

            renderApplications(filteredApps);
        }

        function loadApplicationsDropdown() {
            const dropdown = document.getElementById('keyApplication');

            // Clear existing options except default
            while (dropdown.options.length > 1) {
                dropdown.remove(1);
            }

            // Add applications to dropdown
            allApplications.forEach(app => {
                if (app.name !== 'default') {
                    const option = document.createElement('option');
                    option.value = app.name;
                    option.textContent = app.name;
                    dropdown.appendChild(option);
                }
            });
        }

        async function addApplication() {
            const name = document.getElementById('appName').value.trim();

            if (!name) {
                showNotification('Please enter an application name', 'error');
                return;
            }

            try {
                const result = await apiRequest('/applications', 'POST', { name });

                if (result.success) {
                    showNotification('Application added successfully', 'success');
                    document.getElementById('appName').value = '';
                    refreshApplications();
                }
            } catch (error) {
                // Error is already handled in apiRequest
            }
        }

        async function toggleApplication(name) {
            try {
                const result = await apiRequest(`/applications/${name}/toggle`, 'PUT');
                if (result.success) {
                    showNotification(`Application ${result.isActive ? 'resumed' : 'paused'} successfully`, 'success');
                    refreshApplications();
                }
            } catch (error) {
                // Error is already handled in apiRequest
            }
        }

        function confirmDeleteApplication(name) {
            document.getElementById('confirmationTitle').textContent = 'Delete Application';
            document.getElementById('confirmationMessage').textContent = `Are you sure you want to delete the application: ${name}? All keys will be moved to the default application.`;

            confirmationCallback = async () => {
                try {
                    const result = await apiRequest(`/applications/${name}`, 'DELETE');

                    if (result.success) {
                        showNotification('Application deleted successfully', 'success');
                        refreshApplications();
                    }
                } catch (error) {
                    // Error is already handled in apiRequest
                }
            };

            showPopup('confirmationPopup');
        }

        // Confirmation popup action
        function confirmAction() {
            if (confirmationCallback) {
                confirmationCallback();
                confirmationCallback = null;
                closePopup('confirmationPopup');
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function () {
            // Check if there's a video element and if it has a valid source
            const video = document.getElementById('background-video');
            if (video) {
                video.addEventListener('error', function () {
                    // If video fails to load, hide it
                    video.style.display = 'none';
                });
            }
            
            // Set admin as logged in
            localStorage.setItem('admin', 'true');
            
            // Load initial data
            refreshKeys();
            refreshUsers();
            refreshApplications();
            loadApplicationsDropdown();
        });
    </script>
